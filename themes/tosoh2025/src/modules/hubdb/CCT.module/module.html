{% set title = module.title || 'Competitor Comparison Tool (CCT)' %}
{% set description = module.description || 'Your centralized hub for technical assistance, product resources, and expert guidance across Tosoh Comparison Tool.' %}
{% set tosoh_instrument_id = request.query_dict.tosoh_instrument_id  or "" %}
{% set competitor_instrument_id = request.query_dict.competitor_instrument_id  or "" %}

{# Comparison Table Rows Query #}
{% set comparison_db_query = { query:  '' } %}

{% if tosoh_instrument_id %}
  {% set tmp = comparison_db_query.update({ query: '&tosoh_instrument_id__eq=' ~ tosoh_instrument_id }) %}
{% endif %}

{% if competitor_instrument_id %}
  {% set tmp = comparison_db_query.update({ query: comparison_db_query.query ~ '&competitor_instrument_id__eq=' ~ competitor_instrument_id }) %}
{% endif %}

{% set comparison_rows = hubdb_table_rows("cct_comparison", comparison_db_query.query) %}

{# Instrument Table Rows Query #}
{% set tosoh_rows_query = { query: '&company__eq=Tosoh&deactivate__eq=false' } %}
{% set competitor_rows_query = { query: '&company__ne=Tosoh&deactivate__eq=false' } %}

{% if tosoh_instrument_id %}
  {% set tmp = tosoh_rows_query.update({ query: '&hs_id=' ~ tosoh_instrument_id }) %}
{% endif %}

{% if competitor_instrument_id %}
  {% set tmp = competitor_rows_query.update({ query: '&hs_id=' ~ competitor_instrument_id }) %}
{% endif %}


{# Product Line #}
{% set product_line = request.query_dict.product_line  or "" %}
  {% set product_line_query = { query: '' } %}
  {% if product_line %}  
    {% set tmp = tosoh_rows_query.update({ query: tosoh_rows_query.query ~ '&product_line__eq=' ~ product_line }) %}
  {% endif %}
  

{# fetch rows #}
{% set tosoh_rows = hubdb_table_rows("cct_instruments", tosoh_rows_query.query) %}
{% set competitor_rows = hubdb_table_rows("cct_instruments", competitor_rows_query.query) %}
  

{{tosoh_rows|tojson}}
{{competitor_rows|tojson}}



{% require_js position="head" %}
  <script>
    const productLineRows = {{ product_line_rows|tojson }};
    const tosohRows = {{ tosoh_rows|tojson }};
    const competitorRows = {{ competitor_rows|tojson }};

    window.Tosoh.CCT = { productLineRows, tosohRows, competitorRows};
  </script>
{% end_require_js %}

{# CCT UI #}

<div class="gap-base p-md md:pl-2xl md:pr-2xl mt-[6rem] flex flex-col">
  {% if title || description %}
    <div class="max-w-max-page gap-md p-md md:pl-2xl md:pr-2xl m-auto flex flex-col">
      {% if title %}
        <h2 class="font-bold">{{ title }}</h2>
      {% endif %}

      {% if description %}
        <h6 class="text-nickel">{{ description }}</h6>
      {% endif %}
    </div>
  {% endif %}

  <tosoh-cct-filters></tosoh-cct-filters>
</div>
